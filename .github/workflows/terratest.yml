name: Terratest

on:
  pull_request:
    paths:
      - "**.tf"
      - "test/**"
      - ".github/workflows/terratest.yml"
  push:
    branches:
      - main
      - "feat/**"
  workflow_dispatch:

env:
  GO_VERSION: "1.21"
  TERRAFORM_VERSION: "1.6.0"
  TERRAGRUNT_VERSION: "0.54.0"
  AWS_REGION: "us-east-1"

jobs:
  # Unit tests - fast, cheap, run in parallel
  unit-tests:
    name: Unit Tests - ${{ matrix.module }}
    runs-on: runs-on=${{ github.run_id }}/runner=2cpu-linux-x64
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        module: [storage, optional]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: test/go.sum

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Install Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Go modules
        working-directory: test
        run: go mod download

      - name: Run ${{ matrix.module }} tests
        working-directory: test
        run: |
          MODULE_NAME=$(echo "${{ matrix.module }}" | sed 's/.*/\u&/')
          go test -v -timeout 30m -run Test${MODULE_NAME}
        env:
          RUNS_ON_LICENSE_KEY: ${{ secrets.RUNS_ON_LICENSE_KEY }}
          GITHUB_ORG: ${{ secrets.TEST_GITHUB_ORG }}

  # Scenario tests - medium cost, run in parallel
  scenario-tests:
    name: Scenario - ${{ matrix.scenario }}
    runs-on: runs-on=${{ github.run_id }}/runner=2cpu-linux-x64
    needs: unit-tests
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        scenario: [minimal, public-only, efs-enabled, ecr-enabled]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: test/go.sum

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Install Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Go modules
        working-directory: test
        run: go mod download

      - name: Run ${{ matrix.scenario }} scenario test
        working-directory: test
        run: |
          SCENARIO_NAME=$(echo "${{ matrix.scenario }}" | sed 's/-//g' | sed 's/.*/\u&/')
          go test -v -timeout 45m -run TestScenario${SCENARIO_NAME}
        env:
          RUNS_ON_LICENSE_KEY: ${{ secrets.RUNS_ON_LICENSE_KEY }}
          GITHUB_ORG: ${{ secrets.TEST_GITHUB_ORG }}

  # Expensive tests - only run on main branch or manual trigger
  expensive-tests:
    name: Expensive - ${{ matrix.scenario }}
    runs-on: runs-on=${{ github.run_id }}/runner=2cpu-linux-x64
    needs: scenario-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        scenario: [private-networking, full-featured]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: test/go.sum

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Install Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Go modules
        working-directory: test
        run: go mod download

      - name: Run ${{ matrix.scenario }} scenario test
        working-directory: test
        run: |
          SCENARIO_NAME=$(echo "${{ matrix.scenario }}" | sed 's/-//g' | sed 's/.*/\u&/')
          go test -v -timeout 60m -run TestScenario${SCENARIO_NAME}
        env:
          RUNS_ON_LICENSE_KEY: ${{ secrets.RUNS_ON_LICENSE_KEY }}
          GITHUB_ORG: ${{ secrets.TEST_GITHUB_ORG }}

  # Test summary
  test-summary:
    name: Test Summary
    runs-on: runs-on=${{ github.run_id }}/runner=2cpu-linux-x64
    needs: [unit-tests, scenario-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "::error::Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.scenario-tests.result }}" != "success" ]; then
            echo "::error::Scenario tests failed"
            exit 1
          fi
          echo "::notice::All required tests passed!"
